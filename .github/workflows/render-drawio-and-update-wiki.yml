name: Render drawio + update Wiki images

on:
  push:
    paths:
      - "docs/diagrams/**/*.drawio"

permissions:
  contents: write
  actions: read

jobs:
  render_and_update_wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Reset npm auth (defensive)
        run: |
          rm -f .npmrc || true
          rm -f ~/.npmrc || true
          npm config delete //registry.npmjs.org/:_authToken || true

      - name: Install dependencies for headless rendering
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xvfb libgbm-dev libasound2t64
          npm i -g draw.io-export

      - name: Export PNGs from drawio
        run: |
          set -e
          found=0
          while IFS= read -r f; do
            found=1
            out="${f%.drawio}.png"
            echo "Exporting: $f -> $out"

            xvfb-run --auto-servernum --server-args="-screen 0 1280x1024x24" \
              drawio "$f" -o "$out"

            # Явная проверка что PNG создан и не пустой
            if [ ! -f "$out" ]; then
              echo "ERROR: PNG not created: $out"
              exit 1
            fi
            if [ ! -s "$out" ]; then
              echo "ERROR: PNG is empty: $out"
              exit 1
            fi

            echo "OK: $out ($(du -h "$out" | cut -f1))"
          done < <(find docs/diagrams -name "*.drawio" -type f)

          if [ "$found" -eq 0 ]; then
            echo "No .drawio files found under docs/diagrams"
          fi

      - name: Commit updated PNGs to repo
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add docs/diagrams/**/*.png docs/diagrams/*.png || true

          if git diff --cached --quiet; then
            echo "No PNG changes to commit"
          else
            git commit -m "Auto-render drawio PNG"
            git push origin HEAD
          fi

      - name: Write wiki updater script
        run: |
          cat > /tmp/update_wiki.py << 'PYEOF'
          import os, re, pathlib, sys
          from urllib.parse import urlparse, parse_qs, urlencode, urlunparse

          repo_full = os.environ["REPO_FULL"]
          branch    = os.environ.get("BRANCH", "main")
          v         = os.environ["V"][:7]

          png_list = [x for x in os.environ["PNG_LIST"].strip().splitlines() if x]

          base = f"https://raw.githubusercontent.com/{repo_full}/{branch}/docs/diagrams/"

          md_files = list(pathlib.Path(".").rglob("*.md"))
          if not md_files:
              print("No .md pages found in wiki repo")
              sys.exit(0)

          def normalize_url(url: str) -> str:
              parsed = urlparse(url)
              params = parse_qs(parsed.query, keep_blank_values=True)
              params["raw"] = ["1"]
              params["v"]   = [v]
              new_query = urlencode({k: val[0] for k, val in params.items()})
              return urlunparse(parsed._replace(query=new_query))

          changed_pages = 0

          for p in md_files:
              text = p.read_text(encoding="utf-8")
              orig = text
              for fn in png_list:
                  pattern = re.escape(base + fn) + r"[^\s)\]]*"
                  text = re.sub(pattern, lambda m: normalize_url(m.group(0)), text)
              if text != orig:
                  p.write_text(text, encoding="utf-8")
                  changed_pages += 1
                  print(f"Updated: {p}")

          print(f"Pages changed: {changed_pages}")
          PYEOF

      - name: Update all Wiki pages cache-busters for diagrams
        env:
          WIKI_TOKEN: ${{ secrets.RYNKO_WIKI_TOKEN }}
          REPO_FULL: ${{ github.repository }}
          BRANCH: main
          V: ${{ github.sha }}
        run: |
          set -e

          PNG_LIST="$(find docs/diagrams -type f -name "*.png" -printf "%f\n" || true)"
          export PNG_LIST

          if [ -z "$PNG_LIST" ]; then
            echo "No PNG files found in docs/diagrams - nothing to update in Wiki"
            exit 0
          fi

          git clone "https://github.com/${REPO_FULL}.wiki.git" wiki
          cd wiki
          git remote set-url origin "https://x-access-token:${WIKI_TOKEN}@github.com/${REPO_FULL}.wiki.git"

          python3 /tmp/update_wiki.py

      - name: Commit & push Wiki updates
        env:
          WIKI_TOKEN: ${{ secrets.RYNKO_WIKI_TOKEN }}
          REPO_FULL: ${{ github.repository }}
        run: |
          set -e
          cd "$GITHUB_WORKSPACE/wiki"
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git remote set-url origin "https://x-access-token:${WIKI_TOKEN}@github.com/${REPO_FULL}.wiki.git"

          git add -A

          if git diff --cached --quiet; then
            echo "No Wiki changes to commit"
          else
            git commit -m "Update diagram cache-busters"
            git push
          fi
