name: render-drawio

on:
  push:
    paths:
      - "**.drawio"

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: install drawio exporter
        run: |
          sudo apt update
          sudo apt install xvfb libgtk-3-0 libnotify4 libnss3 libxss1 libxtst6 xdg-utils wget -y
          wget https://github.com/jgraph/drawio-desktop/releases/download/v22.1.0/drawio-amd64-22.1.0.deb
          sudo apt install ./drawio-amd64-22.1.0.deb -y

      - name: export diagrams
        run: |
          for f in $(find . -name "*.drawio"); do
            drawio --export --format svg --output "${f%.drawio}.svg" "$f"
          done

      - name: commit svgs
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add **/*.svg
          git commit -m "auto render diagrams" || echo "no changes"
          git push
